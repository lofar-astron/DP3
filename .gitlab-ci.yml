stages:
  - build
  - build-doc
  - deploy-doc

build:
  stage: build
  script:
  - export DOCKER_IMAGE=${CI_PROJECT_NAME,,}:$CI_COMMIT_SHORT_SHA
  - docker build --tag $DOCKER_IMAGE -f ./docker/ubuntu_20_04_lofar .

build-doc:
  stage: build-doc
  script:
  - export DOCKER_IMAGE=${CI_PROJECT_NAME,,}/doc:$CI_COMMIT_SHORT_SHA
  - docker build --tag $DOCKER_IMAGE -f ./docker/ubuntu_20_04_doc .
  - docker run --name $CI_COMMIT_SHORT_SHA $DOCKER_IMAGE
  - docker cp $CI_COMMIT_SHORT_SHA:/build/doc/html htmldoc
  - docker rm $CI_COMMIT_SHORT_SHA
  artifacts:
    paths:
    - htmldoc

deploy-doc:
  stage: deploy-doc
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | base64 -d | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H dop288 > ~/.ssh/known_hosts
  script:
    - scp -r htmldoc/* citt@dop288:DP3
  only:
    refs:
      - master
